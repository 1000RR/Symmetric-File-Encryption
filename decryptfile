#!/usr/bin/env zsh
set -euo pipefail

source scriptnames.conf

log(){ echo "[decrypt] $*"; }
die(){ echo "Error: $*" >&2; exit 1; }

usage() {
  cat >&2 <<EOF
Usage:
  $(basename "$0") <secret> <salt> <input.enc> <output|outdir>
  $(basename "$0") -k <ENVVAR> <input.enc> <output|outdir>

Notes:
  - In -k mode, \$ENVVAR must be: <ENC_HEX>|||<MAC_HEX> (each 64 hex chars), e.g. from derive-key.zsh
  - Requires sidecars: <input.enc>.iv and <input.enc>.hmac
  - output|outdir:
      * if an existing directory path: output becomes <dir>/<input_basename_without_.enc>
      * if ends with '/': output becomes <that_dir>/<input_basename_without_.enc> (dir will be created)
      * otherwise: treated as output file path (or filename in CWD)
EOF
  exit 1
}

# ---- reject unknown flags ----
if [[ "${1-}" == -* && "${1-}" != "-k" ]]; then
  die "unknown option '$1' (only supported option is: -k <ENVVAR>)"
fi

USE_DERIVED_KEYS=0
ENV_KEY_NAME=""

if [[ "${1-}" == "-k" ]]; then
  [[ $# -eq 4 ]] || usage
  USE_DERIVED_KEYS=1
  ENV_KEY_NAME="$2"
  INPUT="$3"
  OUTSPEC="$4"
else
  [[ $# -eq 4 ]] || usage
  SECRET="$1"
  SALT="$2"
  INPUT="$3"
  OUTSPEC="$4"
fi

log "Validating input..."
[[ -f "$INPUT" ]] || die "encrypted file not found: $INPUT"

IV_FILE="$INPUT.iv"
HMAC_FILE="$INPUT.hmac"
[[ -f "$IV_FILE" && -f "$HMAC_FILE" ]] || die "missing .iv or .hmac sidecar"

IN_BASE="$(basename -- "$INPUT")"
ORIG="${IN_BASE%.enc}"

# ---- resolve output path ----
if [[ -d "$OUTSPEC" ]]; then
  OUT="$OUTSPEC/$ORIG"
elif [[ "$OUTSPEC" == */ ]]; then
  mkdir -p "$OUTSPEC"
  OUT="$OUTSPEC/$ORIG"
else
  case "$OUTSPEC" in
    */*) OUT="$OUTSPEC" ;;
    *)   OUT="$(pwd)/$OUTSPEC" ;;
  esac
fi

[[ ! -e "$OUT" ]] || die "output already exists: $OUT"

# ---- keys ----
if [[ "$USE_DERIVED_KEYS" -eq 1 ]]; then
  log "Using derived ENC|||MAC keys from \$${ENV_KEY_NAME}"
  RAW="${(P)ENV_KEY_NAME}"
  [[ "$RAW" == *"|||"* ]] || die "ENVVAR must contain ENC_HEX|||MAC_HEX"

  ENC_KEY="${RAW%%|||*}"
  MAC_KEY="${RAW##*|||}"

  [[ "$ENC_KEY" =~ ^[0-9a-fA-F]{64}$ ]] || die "invalid ENC key format"
  [[ "$MAC_KEY" =~ ^[0-9a-fA-F]{64}$ ]] || die "invalid MAC key format"
else
  log "Deriving keys via Argon2"
  ENC_KEY="$(printf '%s' "$SECRET" \
    | argon2 "${SALT}|enc" -id -m 23 -t 3 -p 1 -r \
    | openssl dgst -sha256 -binary | xxd -p -c 256)"
  MAC_KEY="$(printf '%s' "$SECRET" \
    | argon2 "${SALT}|mac" -id -m 23 -t 3 -p 1 -r \
    | openssl dgst -sha256 -binary | xxd -p -c 256)"
fi

# ---- verify HMAC ----
log "Verifying HMAC..."
IV="$(tr -d '\n' < "$IV_FILE")"
STORED="$(tr -d '\n' < "$HMAC_FILE")"

TMP="$(mktemp)"
trap 'rm -f "$TMP"' EXIT
printf '%s' "$IV" | xxd -r -p > "$TMP"
cat "$INPUT" >> "$TMP"
CALC="$(openssl dgst -sha256 -mac HMAC -macopt hexkey:"$MAC_KEY" "$TMP" | awk '{print $NF}')"

[[ "$CALC" == "$STORED" ]] || die "HMAC verification failed"

# ---- decrypt ----
log "Decrypting (AES-256-CTR)..."
openssl enc -d -aes-256-ctr \
  -K "$ENC_KEY" \
  -iv "$IV" \
  -in "$INPUT" \
  -out "$OUT"

log "Done."
echo "Recovered: $OUT"
